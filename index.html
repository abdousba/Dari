import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, addDoc, onSnapshot, 
  query, doc, deleteDoc 
} from 'firebase/firestore';
import { 
  getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
} from 'firebase/auth';
import { 
  Search, MapPin, Home, Plus, User, Phone, 
  CheckCircle, Loader2, Trash2, ShieldCheck, 
  Calendar, ChevronRight, X, SlidersHorizontal, 
  UploadCloud, AlertCircle, Tag, Info, UserCheck, 
  Briefcase, FileText, BarChart3, Users, Clock, 
  LayoutDashboard, Eye, Lock
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'dari-algeria-final';

const algerianStates = [
  "أدرار", "الشلف", "الأغواط", "أم البواقي", "باتنة", "بجاية", "بسكرة", "بشار", "البليدة", "البويرة",
  "تمنراست", "تبسة", "تلمسان", "تيارت", "تيزي وزو", "الجزائر العاصمة", "الجلفة", "جيجل", "سطيف", "سعيدة",
  "سكيكدة", "سيدي بلعباس", "عنابة", "قالمة", "قسنطينة", "المدية", "مستغانم", "المسيلة", "معسكر", "ورقلة",
  "وهران", "البيض", "إليزي", "برج بوعريريج", "بومرداس", "الطارف", "تندوف", "تيسمسيلت", "الوادي", "خنشلة",
  "سوق أهراس", "تيبازة", "ميلة", "عين الدفلى", "النعامة", "عين تموشنت", "غرداية", "غليزان", "تيميمون", 
  "برج باجي مختار", "أولاد جلال", "بني عباس", "إن صالح", "إن قزام", "تقرت", "جانت", "المغير", "المنيعة"
];

const formatTimeAgo = (dateString) => {
  const date = new Date(dateString);
  const now = new Date();
  const diffInSeconds = Math.floor((now - date) / 1000);
  if (diffInSeconds < 60) return 'منذ ثوانٍ';
  if (diffInSeconds < 3600) return `منذ ${Math.floor(diffInSeconds / 60)} دقيقة`;
  if (diffInSeconds < 86400) return `منذ ${Math.floor(diffInSeconds / 3600)} ساعة`;
  return `منذ ${Math.floor(diffInSeconds / 86400)} يوم`;
};

const App = () => {
  const [view, setView] = useState('home');
  const [user, setUser] = useState(null);
  const [allProperties, setAllProperties] = useState([]);
  const [filteredProperties, setFilteredProperties] = useState([]);
  const [selectedProperty, setSelectedProperty] = useState(null);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [showFilters, setShowFilters] = useState(false);
  const [notification, setNotification] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);

  const [image1, setImage1] = useState(null);
  const [image2, setImage2] = useState(null);

  // Filter States
  const [tempFilters, setTempFilters] = useState({ 
    minPrice: '', 
    maxPrice: '', 
    state: '', 
    hasDeed: false, 
    hasNotary: false 
  });
  const [appliedFilters, setAppliedFilters] = useState(null);

  const showNotice = (type, message) => {
    setNotification({ type, message });
    setTimeout(() => setNotification(null), 4000);
  };

  useEffect(() => {
    const initAuth = async () => {
      try {
        let currentUser;
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          const res = await signInWithCustomToken(auth, __initial_auth_token);
          currentUser = res.user;
        } else {
          const res = await signInAnonymously(auth);
          currentUser = res.user;
        }
        if (currentUser) setIsAdmin(true); 
      } catch (e) { console.error("Auth Error", e); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'properties');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const sorted = data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      setAllProperties(sorted);
      
      // Apply filters if they exist during data refresh
      if (appliedFilters) {
          applyLogic(sorted, appliedFilters);
      } else {
          setFilteredProperties(sorted);
      }
      setLoading(false);
    }, (error) => {
      showNotice('error', 'فشل تحميل البيانات');
      setLoading(false);
    });
    return () => unsubscribe();
  }, [user, appliedFilters]);

  const stats = useMemo(() => {
    const total = allProperties.length;
    const totalValue = allProperties.reduce((acc, curr) => acc + (Number(curr.price) || 0), 0);
    const avgPrice = total > 0 ? Math.floor(totalValue / total) : 0;
    const statesCount = new Set(allProperties.map(p => p.state)).size;
    return { total, avgPrice, statesCount };
  }, [allProperties]);

  // The actual filtering logic
  const applyLogic = (data, filters) => {
    let result = [...data];
    if (filters.state) result = result.filter(p => p.state === filters.state);
    if (filters.minPrice) result = result.filter(p => p.price >= Number(filters.minPrice));
    if (filters.maxPrice) result = result.filter(p => p.price <= Number(filters.maxPrice));
    if (filters.hasDeed) result = result.filter(p => p.hasDeed === true);
    if (filters.hasNotary) result = result.filter(p => p.hasNotary === true);
    setFilteredProperties(result);
  };

  const handleApplyFilters = () => {
    setAppliedFilters({ ...tempFilters });
    applyLogic(allProperties, tempFilters);
    setShowFilters(false);
  };

  const clearFilters = () => {
    const defaultFilters = { minPrice: '', maxPrice: '', state: '', hasDeed: false, hasNotary: false };
    setTempFilters(defaultFilters);
    setAppliedFilters(null);
    setFilteredProperties(allProperties);
    setShowFilters(false);
  };

  const handleImageUpload = (e, setImg) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setImg(reader.result);
      reader.readAsDataURL(file);
    }
  };

  const handleDelete = async (id) => {
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', id));
      showNotice('success', 'تم حذف الإعلان بنجاح');
      if (view === 'details') setView('home');
    } catch (e) {
      showNotice('error', 'خطأ في عملية الحذف');
    }
  };

  const handleAddProperty = async (e) => {
    e.preventDefault();
    if (!user) return;
    setSubmitting(true);
    const formData = new FormData(e.target);
    
    const newProp = {
      title: formData.get('title'),
      price: Number(formData.get('price')),
      state: formData.get('state'),
      city: formData.get('city'),
      description: formData.get('description'),
      ownerName: formData.get('ownerName'),
      phone: formData.get('phone'),
      hasDeed: formData.get('hasDeed') === 'true',
      hasNotary: formData.get('hasNotary') === 'true',
      prepayment: formData.get('prepayment'),
      image1: image1 || "https://images.unsplash.com/photo-1560518883-ce09059eeffa?auto=format&fit=crop&q=80&w=800",
      image2: image2 || image1 || "https://images.unsplash.com/photo-1484154218962-a197022b5858?auto=format&fit=crop&q=80&w=800",
      ownerId: user.uid,
      createdAt: new Date().toISOString()
    };

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'properties'), newProp);
      showNotice('success', 'تم نشر إعلانك بنجاح');
      setView('home');
      setImage1(null); setImage2(null);
    } catch (err) {
      showNotice('error', 'فشل في النشر');
    } finally {
      setSubmitting(false);
    }
  };

  if (loading) return (
    <div className="h-screen flex items-center justify-center bg-[#FAFAFA]">
      <div className="text-center">
        <Loader2 className="animate-spin text-black mx-auto mb-4" size={40} />
        <p className="font-bold text-gray-400">تحميل داري...</p>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#FAFAFA] text-right font-sans pb-24 text-gray-800" dir="rtl">
      
      {notification && (
        <div className={`fixed top-24 left-1/2 -translate-x-1/2 z-[100] px-8 py-4 rounded-3xl shadow-2xl flex items-center gap-4 animate-in fade-in slide-in-from-top-10 duration-500 ${
          notification.type === 'success' ? 'bg-black text-white' : 'bg-rose-500 text-white'
        }`}>
          {notification.type === 'success' ? <CheckCircle size={20} /> : <AlertCircle size={20} />}
          <span className="font-black">{notification.message}</span>
        </div>
      )}

      {/* Navigation */}
      <nav className="bg-white/90 backdrop-blur-xl border-b sticky top-0 z-[60] px-4 py-4 shadow-sm border-gray-100">
        <div className="max-w-6xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-3 cursor-pointer group" onClick={() => { setView('home'); clearFilters(); }}>
            <div className="bg-black p-2.5 rounded-2xl text-white shadow-lg transition-transform group-hover:scale-110">
                <Home size={22} />
            </div>
            <span className="text-2xl font-black text-black tracking-tight">داري.dz</span>
          </div>

          <div className="flex items-center gap-2">
            {isAdmin && (
              <button onClick={() => setView('admin')} className={`p-2.5 rounded-2xl transition-all ${view === 'admin' ? 'bg-black text-white' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                <LayoutDashboard size={20} />
              </button>
            )}
            <button onClick={() => setShowFilters(!showFilters)} className={`p-2.5 rounded-2xl transition-all ${showFilters || appliedFilters ? 'bg-[#A7C7E7] text-white' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                <SlidersHorizontal size={20} />
            </button>
          </div>
        </div>
      </nav>

      <main className="max-w-6xl mx-auto px-4 mt-8">

        {/* Home / List View */}
        {view === 'home' && (
          <>
            {!appliedFilters && (
                <section className="bg-white rounded-[3rem] p-12 mb-10 border border-gray-100 shadow-sm relative overflow-hidden">
                    <div className="relative z-10 max-w-2xl">
                        <h1 className="text-5xl font-black text-black mb-6 leading-tight">بيت أحلامك <br/><span className="text-gray-400">في انتظارك.</span></h1>
                        <p className="text-lg text-gray-500 font-medium">المنصة الجزائرية الأولى للكراء المباشر. تصفح آلاف الإعلانات الحقيقية في كل الولايات.</p>
                        <div className="mt-8 flex gap-4">
                            <button onClick={() => setView('add')} className="bg-black text-white px-8 py-4 rounded-2xl font-black shadow-xl shadow-black/10 hover:scale-105 transition-transform">انشر مجاناً</button>
                            <button onClick={() => setView('about')} className="bg-gray-100 text-gray-600 px-8 py-4 rounded-2xl font-bold">من نحن؟</button>
                        </div>
                    </div>
                </section>
            )}

            {/* Filter Panel */}
            {showFilters && (
                <div className="bg-white rounded-[2.5rem] border border-gray-100 p-8 mb-10 shadow-xl animate-in slide-in-from-top-5">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div className="space-y-2">
                            <label className="text-xs font-black text-gray-400 uppercase">الولاية</label>
                            <select className="w-full p-4 bg-gray-50 border-0 rounded-2xl ring-1 ring-gray-100 outline-none" value={tempFilters.state} onChange={(e) => setTempFilters({...tempFilters, state: e.target.value})}>
                                <option value="">كل الجزائر</option>
                                {algerianStates.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                        </div>
                        <div className="space-y-2">
                            <label className="text-xs font-black text-gray-400 uppercase">السعر الأقصى (دج)</label>
                            <input type="number" placeholder="مثال: 40000" className="w-full p-4 bg-gray-50 border-0 rounded-2xl ring-1 ring-gray-100 outline-none" value={tempFilters.maxPrice} onChange={(e) => setTempFilters({...tempFilters, maxPrice: e.target.value})} />
                        </div>
                        <div className="flex flex-col justify-end space-y-2 pb-2">
                            <label className="flex items-center gap-3 cursor-pointer text-sm font-bold">
                                <input type="checkbox" checked={tempFilters.hasDeed} onChange={(e) => setTempFilters({...tempFilters, hasDeed: e.target.checked})} className="w-5 h-5 accent-black" /> شهادة ملكية
                            </label>
                            <label className="flex items-center gap-3 cursor-pointer text-sm font-bold">
                                <input type="checkbox" checked={tempFilters.hasNotary} onChange={(e) => setTempFilters({...tempFilters, hasNotary: e.target.checked})} className="w-5 h-5 accent-black" /> عقد موثق
                            </label>
                        </div>
                        <div className="flex items-end gap-2">
                            <button onClick={handleApplyFilters} className="flex-1 bg-black text-white py-4 rounded-2xl font-black">بحث</button>
                            <button onClick={clearFilters} className="p-4 bg-gray-100 rounded-2xl text-gray-400"><X size={20} /></button>
                        </div>
                    </div>
                </div>
            )}

            <div className="flex justify-between items-center mb-8">
                <h2 className="text-2xl font-black text-black">آخر العقارات</h2>
                <div className="text-sm font-bold text-gray-400">{filteredProperties.length} نتيجة</div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
              {filteredProperties.length > 0 ? filteredProperties.map(p => (
                <div key={p.id} className="bg-white rounded-[2.5rem] overflow-hidden border border-gray-100 hover:shadow-2xl transition-all duration-500 group cursor-pointer" onClick={() => {setSelectedProperty(p); setView('details')}}>
                  <div className="relative h-64 overflow-hidden">
                    <img src={p.image1} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" alt={p.title} />
                    <div className="absolute top-4 left-4 bg-black/80 backdrop-blur-md px-4 py-2 rounded-2xl font-black text-white shadow-xl text-sm">
                      {Number(p.price).toLocaleString()} دج
                    </div>
                    <div className="absolute bottom-4 right-4 bg-white/90 backdrop-blur-md px-3 py-1.5 rounded-xl text-[10px] font-black text-black flex items-center gap-1.5 shadow-sm">
                        <Clock size={12} /> {formatTimeAgo(p.createdAt)}
                    </div>
                  </div>
                  <div className="p-7 space-y-3">
                    <h3 className="text-xl font-bold text-gray-800 leading-tight group-hover:text-black transition-colors line-clamp-1">{p.title}</h3>
                    <div className="flex items-center gap-2 text-gray-400 text-sm font-bold">
                      <MapPin size={16} className="text-[#A7C7E7]" />
                      {p.state} - {p.city}
                    </div>
                    <div className="flex gap-2 pt-4 border-t border-gray-50">
                        {p.hasDeed && <span className="bg-green-50 text-green-600 text-[10px] px-3 py-1.5 rounded-full font-black">ملكية</span>}
                        {p.hasNotary && <span className="bg-blue-50 text-blue-600 text-[10px] px-3 py-1.5 rounded-full font-black">موثق</span>}
                        <span className="bg-gray-50 text-gray-400 text-[10px] px-3 py-1.5 rounded-full font-black">{p.prepayment}</span>
                    </div>
                  </div>
                </div>
              )) : (
                <div className="col-span-full py-24 text-center bg-gray-50 rounded-[3rem] border-2 border-dashed border-gray-200">
                    <Search size={50} className="mx-auto text-gray-300 mb-4" />
                    <p className="text-gray-500 font-black">لم نجد أي نتائج تطابق هذا البحث.</p>
                    <button onClick={clearFilters} className="mt-4 text-black underline font-bold">عرض جميع العقارات</button>
                </div>
              )}
            </div>
          </>
        )}

        {/* Details View */}
        {view === 'details' && selectedProperty && (
          <div className="max-w-5xl mx-auto animate-in fade-in slide-in-from-bottom-5">
            <button onClick={() => setView('home')} className="flex items-center gap-2 text-gray-400 font-black mb-6 hover:text-black transition-colors">
               <ChevronRight size={20} className="rotate-180" /> الرجوع
            </button>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
              <img src={selectedProperty.image1} className="w-full h-96 object-cover rounded-[3rem] shadow-sm" />
              <img src={selectedProperty.image2} className="w-full h-96 object-cover rounded-[3rem] shadow-sm" />
            </div>

            <div className="flex flex-col lg:flex-row gap-10">
              <div className="flex-1 space-y-8">
                <div className="space-y-4">
                    <div className="text-sm font-bold text-[#A7C7E7] flex items-center gap-2">
                        <Clock size={16}/> نشر {formatTimeAgo(selectedProperty.createdAt)}
                    </div>
                    <h1 className="text-4xl font-black text-black">{selectedProperty.title}</h1>
                    <p className="flex items-center gap-2 text-xl text-gray-500">
                        <MapPin size={24} /> {selectedProperty.state}، {selectedProperty.city}
                    </p>
                </div>

                <div className="bg-white p-10 rounded-[2.5rem] border border-gray-100">
                    <h3 className="text-xl font-black mb-6 border-b pb-4">التفاصيل</h3>
                    <p className="text-lg text-gray-600 leading-relaxed whitespace-pre-wrap">{selectedProperty.description || "لا يوجد وصف إضافي."}</p>
                </div>

                {(user?.uid === selectedProperty.ownerId || isAdmin) && (
                    <button onClick={() => handleDelete(selectedProperty.id)} className="text-rose-500 font-bold flex items-center gap-2 px-6 py-3 bg-rose-50 rounded-2xl">
                        <Trash2 size={18} /> حذف الإعلان
                    </button>
                )}
              </div>

              <div className="w-full lg:w-96">
                <div className="bg-black p-10 rounded-[3rem] text-white space-y-8 sticky top-32 shadow-2xl">
                    <div className="text-center">
                        <div className="text-gray-400 font-bold mb-2">السعر الشهري</div>
                        <div className="text-5xl font-black">{Number(selectedProperty.price).toLocaleString()} <span className="text-lg">دج</span></div>
                    </div>
                    
                    <div className="pt-8 border-t border-white/10 space-y-6">
                        <div className="text-center font-bold text-xl flex items-center justify-center gap-2">
                           <User size={20} /> {selectedProperty.ownerName}
                        </div>
                        <a href={`tel:${selectedProperty.phone}`} className="w-full bg-white text-black py-5 rounded-2xl font-black flex items-center justify-center gap-3 text-xl hover:bg-gray-100 transition shadow-xl shadow-black/20">
                            <Phone size={24} /> اتصل بالمالك
                        </a>
                    </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Add View */}
        {view === 'add' && (
          <div className="max-w-2xl mx-auto bg-white p-10 rounded-[3rem] shadow-xl border border-gray-100 animate-in zoom-in-95">
            <div className="flex justify-between items-center mb-10">
                <h2 className="text-3xl font-black text-black">إضافة إعلان</h2>
                <button onClick={() => setView('home')} className="p-3 bg-gray-50 rounded-full text-gray-400"><X size={24} /></button>
            </div>
            
            <form onSubmit={handleAddProperty} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input name="ownerName" required placeholder="اسم المالك" className="w-full p-4 bg-gray-50 border-0 rounded-2xl ring-1 ring-gray-100 focus:ring-black outline-none transition-all" />
                <input name="phone" required placeholder="رقم الهاتف" className="w-full p-4 bg-gray-50 border-0 rounded-2xl ring-1 ring-gray-100 focus:ring-black outline-none transition-all" />
              </div>

              <input name="title" required placeholder="عنوان الإعلان (مثلاً: شقة F3 للكراء)" className="w-full p-4 bg-gray-50 border-0 rounded-2xl ring-1 ring-gray-100 focus:ring-black outline-none transition-all" />

              <div className="grid grid-cols-2 gap-4">
                  <select name="state" className="p-4 bg-gray-50 border-0 rounded-2xl ring-1 ring-gray-100 outline-none">
                      {algerianStates.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                  <input name="city" required placeholder="البلدية" className="p-4 bg-gray-50 border-0 rounded-2xl ring-1 ring-gray-100 outline-none focus:ring-black transition-all" />
              </div>

              <div className="grid grid-cols-2 gap-4">
                  <input name="price" type="number" required placeholder="السعر الشهري" className="p-4 bg-gray-50 border-0 rounded-2xl ring-1 ring-gray-100 focus:ring-black outline-none transition-all" />
                  <select name="prepayment" className="p-4 bg-gray-50 border-0 rounded-2xl ring-1 ring-gray-100 outline-none">
                      <option value="شهري">شهري</option>
                      <option value="3 أشهر">3 أشهر</option>
                      <option value="6 أشهر">6 أشهر</option>
                      <option value="سنة">سنة كاملة</option>
                  </select>
              </div>

              <div className="flex gap-6 p-4 bg-gray-50 rounded-2xl border border-gray-100">
                <label className="flex items-center gap-3 cursor-pointer text-sm font-bold">
                    <input type="checkbox" name="hasDeed" value="true" className="w-5 h-5 accent-black" /> شهادة ملكية
                </label>
                <label className="flex items-center gap-3 cursor-pointer text-sm font-bold">
                    <input type="checkbox" name="hasNotary" value="true" className="w-5 h-5 accent-black" /> عقد موثق
                </label>
              </div>

              <textarea name="description" rows="4" placeholder="وصف العقار..." className="w-full p-4 bg-gray-50 border-0 rounded-2xl ring-1 ring-gray-100 focus:ring-black outline-none transition-all"></textarea>

              <div className="space-y-4">
                <label className="text-sm font-black text-gray-500 pr-2">صور العقار</label>
                <div className="grid grid-cols-2 gap-4">
                    <div className="relative h-32 bg-gray-50 border-2 border-dashed border-gray-200 rounded-2xl flex items-center justify-center overflow-hidden hover:bg-gray-100 transition-colors">
                        {image1 ? <img src={image1} className="w-full h-full object-cover" /> : <Plus size={32} className="text-gray-300" />}
                        <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, setImage1)} className="absolute inset-0 opacity-0 cursor-pointer" />
                    </div>
                    <div className="relative h-32 bg-gray-50 border-2 border-dashed border-gray-200 rounded-2xl flex items-center justify-center overflow-hidden hover:bg-gray-100 transition-colors">
                        {image2 ? <img src={image2} className="w-full h-full object-cover" /> : <Plus size={32} className="text-gray-300" />}
                        <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, setImage2)} className="absolute inset-0 opacity-0 cursor-pointer" />
                    </div>
                </div>
              </div>

              <button disabled={submitting} className="w-full bg-black text-white py-6 rounded-2xl font-black text-xl shadow-xl hover:scale-[1.01] transition-all">
                {submitting ? <Loader2 className="animate-spin mx-auto" /> : "نشر الإعلان الآن"}
              </button>
            </form>
          </div>
        )}

        {/* Admin Dashboard */}
        {view === 'admin' && (
          <div className="animate-in fade-in slide-in-from-top-5">
            <h2 className="text-3xl font-black text-black mb-8">إحصائيات الإدارة</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div className="bg-white p-8 rounded-[2.5rem] border border-gray-100">
                    <div className="text-3xl font-black">{stats.total}</div>
                    <div className="text-gray-400 font-bold">إجمالي الإعلانات</div>
                </div>
                <div className="bg-white p-8 rounded-[2.5rem] border border-gray-100">
                    <div className="text-3xl font-black">{stats.statesCount}</div>
                    <div className="text-gray-400 font-bold">ولايات نشطة</div>
                </div>
                <div className="bg-white p-8 rounded-[2.5rem] border border-gray-100">
                    <div className="text-3xl font-black">{stats.avgPrice.toLocaleString()} دج</div>
                    <div className="text-gray-400 font-bold">متوسط الأسعار</div>
                </div>
            </div>

            <div className="bg-white rounded-[2.5rem] border border-gray-100 overflow-hidden shadow-sm">
                <table className="w-full text-right">
                    <thead>
                        <tr className="bg-gray-50 text-gray-400 text-sm font-black uppercase">
                            <th className="p-6">العقار</th>
                            <th className="p-6">المعلن</th>
                            <th className="p-6">السعر</th>
                            <th className="p-6 text-center">حذف</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-50">
                        {allProperties.map(p => (
                            <tr key={p.id} className="hover:bg-gray-50/50">
                                <td className="p-6 font-bold">{p.title}</td>
                                <td className="p-6">{p.ownerName} ({p.phone})</td>
                                <td className="p-6 font-black">{p.price.toLocaleString()} دج</td>
                                <td className="p-6 text-center text-rose-500">
                                    <button onClick={() => handleDelete(p.id)}><Trash2 size={20}/></button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
          </div>
        )}

        {/* Static Pages */}
        {view === 'about' && (
          <div className="max-w-2xl mx-auto py-12 text-center space-y-8 animate-in fade-in">
             <h2 className="text-5xl font-black">داري.dz</h2>
             <p className="text-xl text-gray-500 leading-relaxed">نحن نهدف لتسهيل عملية الكراء في الجزائر من خلال منصة شفافة تربط المالك بالمستأجر مباشرة وبدون عمولات.</p>
             <button onClick={() => setView('home')} className="text-black font-black underline">الرجوع للرئيسية</button>
          </div>
        )}

        {view === 'privacy' && (
          <div className="max-w-2xl mx-auto py-12 space-y-8">
            <h2 className="text-3xl font-black">سياسة الخصوصية</h2>
            <div className="bg-white p-10 rounded-[2.5rem] text-gray-600 leading-relaxed shadow-sm space-y-4">
                <p>نحن نحترم خصوصية بياناتك. رقم الهاتف والاسم المقدمين يستخدمان فقط لأغراض التواصل المتعلقة بالإيجار.</p>
                <p>يتحمل المعلن المسؤولية الكاملة عن الصور والمعلومات التي يتم رفعها على المنصة.</p>
            </div>
            <button onClick={() => setView('home')} className="block mx-auto text-black font-black underline">الرجوع</button>
          </div>
        )}

      </main>

      {/* Fixed Bottom Bar */}
      <footer className="fixed bottom-0 inset-x-0 bg-white/80 backdrop-blur-xl border-t border-gray-100 px-8 py-4 z-50">
        <div className="max-w-md mx-auto flex justify-between items-center text-gray-400">
            <button onClick={() => { setView('home'); clearFilters(); }} className={`flex flex-col items-center gap-1 ${view === 'home' ? 'text-black' : ''}`}>
                <Home size={22} />
                <span className="text-[10px] font-black">الرئيسية</span>
            </button>
            <button onClick={() => setView('add')} className="flex flex-col items-center gap-1 -mt-10">
                <div className="bg-black text-white p-4 rounded-full shadow-2xl border-4 border-white">
                    <Plus size={24} strokeWidth={3} />
                </div>
            </button>
            <button onClick={() => setView('privacy')} className={`flex flex-col items-center gap-1 ${view === 'privacy' ? 'text-black' : ''}`}>
                <Lock size={22} />
                <span className="text-[10px] font-black">الخصوصية</span>
            </button>
        </div>
      </footer>
    </div>
  );
};

export default App;
